<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Society App - Pay QR</title>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #e0f2fe);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      padding-top: 4mm;
      padding-bottom: 60px; /* Increased to accommodate message */
      box-sizing: border-box;
    }

    .cover-image {
      width: 100%;
      height: auto;
      max-height: 169px;
      object-fit: cover;
      animation: fadeIn 1s ease-in-out;
      position: fixed;
      top: 4mm;
      left: 0;
      z-index: 1000;
      background: white;
    }

    .card-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 100%;
      padding: 0 10px;
      box-sizing: border-box;
      margin-top: 80px;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 15px 40px rgba(0, 122, 193, 0.3);
      margin: 15px auto;
      border: 1px solid #e0e7ff;
      text-align: center;
      animation: fadeIn 1.5s ease-in-out;
    }

    .card canvas.qr {
      width: 200px;
      height: 200px;
      margin: 15px auto;
      display: none;
    }

    .qr-show {
      display: block !important;
    }

    h1 {
      margin-bottom: 15px;
      font-size: 22px;
      color: #007AC1;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    p {
      margin: 5px 0;
      color: #007AC1;
      font-size: 14px;
    }

    .due-amount {
      font-size: 18px;
      font-weight: bold;
      color: #007AC1;
      margin: 10px 0;
    }

    input {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #c3e8ff;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      background: #f0f9ff;
      transition: border-color 0.3s ease;
    }

    input:focus {
      border-color: #007AC1;
      outline: none;
    }

    .or-text {
      font-size: 12px;
      color: #007AC1;
      margin: 5px 0;
    }

    button {
      width: 80%;
      padding: 12px;
      margin: 8px 0;
      background: #007AC1;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 122, 193, 0.2);
    }

    button:hover {
      background: #005f99;
      transform: translateY(-2px);
    }

    .footer {
      width: 100%;
      background: #007AC1;
      color: #ffffff;
      text-align: center;
      padding: 10px 0;
      font-size: 12px;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 1000;
    }

    .note {
      font-size: 10px;
      color: #007AC1;
      margin-top: 8px;
      text-align: center;
    }

    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      text-align: center;
    }

    .popup p {
      margin: 0 0 15px;
      font-size: 14px;
      color: #007AC1;
    }

    .popup button {
      width: 100px;
    }

    @media (min-width: 768px) {
      .card { max-width: 450px; }
      input, button { font-size: 16px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
  <img src="https://i.ibb.co/wNGKBbyT/poster-2025-08-04-123527.png" alt="Top Poster" class="cover-image" />
  <div class="card-container">
    <div class="card">
      <h1>Pay by UPI</h1>
      <div id="qrcode" class="qr"></div>
      <p id="memberNumberDisplay"></p>
      <p class="due-amount" id="dueAmountDisplay"></p>
      <input type="number" id="editableAmount" placeholder="Enter Custom Amount (Optional)" oninput="preventNegative()" />
      <button onclick="payNow()">Pay Now</button>
      <p class="or-text">or</p>
      <button onclick="generateQRCode()">Generate QR Code</button>
      <p class="note">
        Ensure your payment is made to Cochin Shipyard Staff Cooperative House Construction Society. If payment is successful, you can download the receipt from the transaction list within the next working day.
      </p>
    </div>
  </div>
  <div class="popup" id="noLoanPopup">
    <p>No Loan Details for You</p>
    <button onclick="closePopup()">OK</button>
  </div>
  <div class="footer">CSSCHCS | VTSoft | © 2025</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDX_xJLR_FnVg3e_v-e7ZBnaBGAyMVyj1s",
      authDomain: "probanker-2bce7.firebaseapp.com",
      projectId: "probanker-2bce7",
      storageBucket: "probanker-2bce7.appspot.com",
      messagingSenderId: "27106244956",
      appId: "1:27106244956:web:59792c9dc94aa8e5232999",
      measurementId: "G-31138VCDFZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let qrcode = null;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          const memberNumber = data.memberNumber;
          document.getElementById('memberNumberDisplay').textContent = `Member Number: ${memberNumber}`;
          fetchLoanDetails(memberNumber);
        } else {
          document.getElementById('memberNumberDisplay').textContent = 'User not found!';
        }
      } else {
        window.location.href = 'home.html';
      }
    });

    async function fetchLoanDetails(memberNumber) {
      clearFields();
      try {
        const usersSnapshot = await getDocs(query(collection(db, 'users'), where('memberNumber', '==', memberNumber)));
        if (!usersSnapshot.empty) {
          const userDoc = usersSnapshot.docs[0];
          const userId = userDoc.id;

          const loansSnapshot = await getDocs(query(collection(db, 'loans'), where('userId', '==', userId)));
          if (!loansSnapshot.empty) {
            const loanDoc = loansSnapshot.docs[0];
            const loanData = loanDoc.data();
            const loanId = loanDoc.id;
            const loanNumber = loanId.includes('_') ? loanId.split('_')[1] : loanId;

            const paymentsSnapshot = await getDocs(query(
              collection(db, 'payments'),
              where('userId', '==', userId),
              where('loanNumber', '==', loanNumber),
              orderBy('timestamp', 'desc'),
              limit(1)
            ));

            const lastPaymentDate = paymentsSnapshot.empty
              ? loanData.startDate
              : paymentsSnapshot.docs[0].data().date;

            const lastDate = new Date(lastPaymentDate);
            const todayDate = new Date();
            const daysDiff = Math.max(0, Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24)));

            const principalPerInstallment = loanData.amount / loanData.installments || 0;
            const interestRate = loanData.interest || 12;
            const monthlyInterestRate = interestRate / 12 / 100;
            const interestDueDays = Math.max(0, loanData.balance * monthlyInterestRate * (daysDiff / 30));
            const interestDueExtra = loanData.interestDue || 0;
            const principalDueExtra = paymentsSnapshot.empty ? 0 : (paymentsSnapshot.docs[0].data().principalDue || 0);

            const dueAmount = principalPerInstallment + interestDueDays + interestDueExtra + principalDueExtra;
            document.getElementById('dueAmountDisplay').textContent = `Due Amount: ₹${dueAmount.toFixed(2)}`;
          } else {
            document.getElementById('noLoanPopup').style.display = 'block';
            document.getElementById('dueAmountDisplay').textContent = 'Due Amount: ₹0';
          }
        } else {
          document.getElementById('memberNumberDisplay').textContent = 'Member not found!';
        }
      } catch (error) {
        console.error('Error fetching loan details:', error);
        document.getElementById('memberNumberDisplay').textContent = `Error: ${error.message}`;
      }
    }

    function closePopup() {
      document.getElementById('noLoanPopup').style.display = 'none';
      window.location.href = 'home.html';
    }

    function clearFields() {
      document.getElementById('dueAmountDisplay').textContent = '';
      document.getElementById('editableAmount').value = '';
      if (qrcode) qrcode.clear();
      document.getElementById('qrcode').innerHTML = '';
      document.getElementById('qrcode').classList.remove('qr-show');
    }

    function preventNegative() {
      const editableAmount = document.getElementById('editableAmount');
      if (parseFloat(editableAmount.value) < 0) editableAmount.value = '';
    }

    window.generateQRCode = function () {
      const memberNumber = document.getElementById('memberNumberDisplay').textContent.replace('Member Number: ', '').trim();
      const dueAmountDisplay = document.getElementById('dueAmountDisplay').textContent.replace('Due Amount: ₹', '').trim();
      const editableAmount = document.getElementById('editableAmount').value.trim() || dueAmountDisplay;
      const amount = parseFloat(editableAmount) || 0;

      if (!memberNumber || amount <= 0) {
        alert('Please ensure a valid amount is available.');
        return;
      }

      const upiID = '9495926316@okbizaxis';
      const payeeName = 'Cochinshipyard Staff Co.op House';
      const upiURL = `upi://pay?pa=${encodeURIComponent(upiID)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=MemberNo:${memberNumber}`;

      const qrEl = document.getElementById('qrcode');
      if (qrcode) qrcode.clear();
      qrcode = new QRCode(qrEl, {
        text: upiURL,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
      qrEl.classList.add('qr-show');
    };

    window.payNow = function () {
      const memberNumber = document.getElementById('memberNumberDisplay').textContent.replace('Member Number: ', '').trim();
      const dueAmountDisplay = document.getElementById('dueAmountDisplay').textContent.replace('Due Amount: ₹', '').trim();
      const editableAmount = document.getElementById('editableAmount').value.trim() || dueAmountDisplay;
      const amount = parseFloat(editableAmount) || 0;

      if (!memberNumber || amount <= 0) {
        alert('Please ensure a valid amount is available.');
        return;
      }

      const upiID = '9495926316@okbizaxis';
      const payeeName = 'Cochinshipyard Staff Co.op House';
      const upiURL = `upi://pay?pa=${encodeURIComponent(upiID)}&pn=${encodeURIComponent(payeeName)}&am=${amount}&cu=INR&tn=MemberNo:${memberNumber}`;

      try {
        window.location.href = upiURL;
        console.log('Attempting to trigger UPI:', upiURL);
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 100);
      } catch (error) {
        console.error('UPI redirect error:', error);
        alert('UPI app not triggered. Ensure a UPI app is installed.');
        window.location.href = 'index.html';
      }
    };
  </script>
</body>
</html>